<app-toolbar></app-toolbar>

<div class="pot-details-container">
  <div class="header-section">
    <div class="header-left">
      <button mat-icon-button class="back-button" (click)="goBack()">
        <mat-icon class="back-icon">arrow_back</mat-icon>
      </button>
      <h1 class="page-title">{{ potDetails.name }}</h1>
    </div>
    <div class="header-actions">
      <button mat-stroked-button class="edit-button" (click)="editPot()">
        <mat-icon>edit</mat-icon>
        Editar
      </button>
      <button mat-icon-button class="menu-button">
        <mat-icon>more_vert</mat-icon>
      </button>
      <button (click)="openPlantSelector()">Seleccionar Planta para la Maceta</button>

      <app-plant-catalog
        *ngIf="isModalOpen"
        (plantAssigned)="onPlantSelected($event)"
        (cancelled)="onModalCancelled()">
      </app-plant-catalog>
    </div>
  </div>

  <div class="content-wrapper">
    <div class="main-layout">
      <!-- Columna Izquierda -->
      <div class="left-column">
        <mat-card class="pot-info-card">
          <div class="pot-image-container">
            <img [src]="potDetails.image" [alt]="potDetails.name" class="pot-image" />
          </div>

          <div class="pot-basic-info">
            <h2 class="pot-name">{{ potDetails.name }}</h2>
            <p class="pot-type">{{ potDetails.plantType }}</p>
            <p class="pot-description">{{ potDetails.description }}</p>
          </div>

          <div class="care-info">
            <div class="care-item">
              <mat-icon class="care-icon">schedule</mat-icon>
              <div class="care-details">
                <span class="care-label">Horario de riego:</span>
                <span class="care-value">{{ potDetails.wateringSchedule }}</span>
              </div>
            </div>

            <div class="care-item">
              <mat-icon class="care-icon">wb_sunny</mat-icon>
              <div class="care-details">
                <span class="care-label">Exposición al sol:</span>
                <span class="care-value">{{ potDetails.sunExposure }}</span>
              </div>
            </div>

            <div class="care-item">
              <mat-icon class="care-icon">water_drop</mat-icon>
              <div class="care-details">
                <span class="care-label">Humedad óptima:</span>
                <span class="care-value">{{ potDetails.optimalHumidity }}</span>
              </div>
            </div>
          </div>
        </mat-card>

        <mat-card class="battery-card">
          <h3 class="battery-title">Estado de la batería</h3>
          <div class="battery-info">
            <div class="battery-level">
              <span class="battery-label">Nivel de batería</span>
              <span class="battery-percentage">{{ potDetails.batteryLevel }}%</span>
            </div>
            <mat-progress-bar
              mode="determinate"
              [value]="potDetails.batteryLevel"
              class="battery-bar"
              [style.--progress-color]="getBatteryColor()">
            </mat-progress-bar>
            <p class="battery-status">Batería en buen estado</p>
          </div>
        </mat-card>
      </div>

      <!-- Columna Derecha -->
      <div class="right-column">
        <!-- Métricas -->
        <div class="metrics-grid">
          <mat-card *ngFor="let metric of metrics" class="metric-card">
            <div class="metric-header">
              <mat-icon class="metric-icon">{{ metric.icon }}</mat-icon>
              <span class="metric-name">{{ metric.name }}</span>
            </div>
            <div class="metric-value">
              <span class="value">{{ metric.value }}</span>
              <span class="unit">{{ metric.unit }}</span>
            </div>
            <mat-progress-bar
              mode="determinate"
              [value]="metric.percentage"
              class="metric-bar"
              [style.--progress-color]="getMetricColor(metric)">
            </mat-progress-bar>
            <p class="metric-optimal">{{ metric.optimal }}</p>
          </mat-card>
        </div>

        <!-- Control de Riego -->
        <mat-card class="watering-control">
          <div class="watering-header">
            <h3 class="watering-title">Control De Riego</h3>
            <p class="watering-status">El nivel de humedad del suelo es adecuado</p>
          </div>
          <button mat-raised-button class="water-button" (click)="waterPlant()">
            <mat-icon>water_drop</mat-icon>
            Regar ahora
          </button>
        </mat-card>

        <!-- Tabs -->
        <mat-card class="tabs-card">
          <mat-tab-group
            class="details-tabs"
            (selectedTabChange)="onTabChange($event.index)"
            [selectedIndex]="selectedTabIndex"
            animationDuration="200ms">

            <mat-tab label="Gráfico"></mat-tab>
            <mat-tab label="Historial"></mat-tab>
            <mat-tab label="Recomendaciones"></mat-tab>
            <mat-tab label="Alertas"></mat-tab>
            <mat-tab label="Reportes"></mat-tab>
            <mat-tab label="Programación">
              <div class="programming-content">
                <div class="programming-header">
                  <h3>Programación de riego</h3>
                  <p>Configura cuándo y cuánto regar tus plantas. Recuerde que se requiere al menos 10% de batería para el riego automático</p>
                </div>

                <!-- Formulario Nueva Programación -->
                <div *ngIf="showNewScheduleForm" class="new-schedule-form">
                  <h4 class="form-title">Nueva programación</h4>
                  <form [formGroup]="newScheduleForm" class="schedule-form">
                    <div class="form-row">
                      <div class="form-field">
                        <label class="field-label">Día</label>
                        <mat-form-field appearance="outline" class="full-width">
                          <mat-select formControlName="day" placeholder="Seleccionar día" style="padding-left:12px">
                            <mat-option *ngFor="let day of daysOfWeek" [value]="day.value">
                              {{ day.label }}
                            </mat-option>
                          </mat-select>
                          <mat-error *ngIf="day?.hasError('required')">
                            Selecciona un día
                          </mat-error>
                        </mat-form-field>
                      </div>

                      <div class="form-field">
                        <label class="field-label">Hora</label>
                        <mat-form-field appearance="outline" class="full-width">
                          <input matInput type="time" formControlName="time" placeholder="--:--" style="padding-left:12px">
                          <mat-error *ngIf="time?.hasError('required')">
                            Selecciona una hora
                          </mat-error>
                        </mat-form-field>
                      </div>

                      <div class="form-field">
                        <label class="field-label">Cantidad (ml)</label>
                        <mat-form-field appearance="outline" class="full-width">
                          <input matInput type="number" formControlName="amount" placeholder="200ml" style="padding-left:12px" >
                          <mat-error *ngIf="amount?.hasError('required')">
                            Ingresa la cantidad
                          </mat-error>
                          <mat-error *ngIf="amount?.hasError('min')">
                            Mínimo 50ml
                          </mat-error>
                          <mat-error *ngIf="amount?.hasError('max')">
                            Máximo 1000ml
                          </mat-error>
                        </mat-form-field>
                      </div>
                    </div>

                    <div class="form-actions">
                      <button mat-stroked-button type="button" class="cancel-btn" (click)="cancelNewSchedule()">
                        Cancelar
                      </button>
                      <button
                        mat-raised-button
                        type="button"
                        class="save-btn"
                        [disabled]="newScheduleForm.invalid"
                        (click)="saveNewSchedule()">
                        <mat-icon>save</mat-icon>
                        Guardar
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Lista de Programaciones -->
                <div *ngIf="hasSchedules" class="schedules-list">
                  <div *ngFor="let schedule of wateringSchedules" class="schedule-item">
                    <div class="schedule-icon">
                      <mat-icon>water_drop</mat-icon>
                    </div>
                    <div class="schedule-info">
                      <div class="schedule-day">
                        <mat-icon class="day-icon">event</mat-icon>
                        <span class="day-text">{{ getDayLabel(schedule.day) }}</span>
                      </div>
                      <div class="schedule-details">
                        <mat-icon class="time-icon">schedule</mat-icon>
                        <span class="time-text">{{ schedule.time }} - {{ schedule.amount }}ml</span>
                      </div>
                    </div>
                    <div class="schedule-actions">
                      <mat-slide-toggle
                        [checked]="schedule.isActive"
                        (change)="toggleSchedule(schedule.id)"
                        class="schedule-toggle">
                      </mat-slide-toggle>
                      <button
                        mat-icon-button
                        class="delete-btn"
                        (click)="deleteSchedule(schedule.id)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Estado vacío o botón añadir -->
                <div *ngIf="!hasSchedules && !showNewScheduleForm" class="empty-state">
                  <mat-icon class="empty-icon">search</mat-icon>
                  <h4 class="empty-title">Tu planta no tiene un riego automático programado.</h4>
                  <p class="empty-description">
                    Te recomendamos configurar al menos un período de riego automático para aprovechar al máximo nuestra aplicación y contribuir al bienestar e hidratación de tu planta.
                  </p>
                  <button mat-raised-button class="add-button" (click)="showAddScheduleForm()">
                    <mat-icon>add</mat-icon>
                    Añadir
                  </button>
                </div>

                <!-- Botón añadir cuando hay programaciones -->
                <div *ngIf="hasSchedules && !showNewScheduleForm" class="add-more-section">
                  <button mat-raised-button class="add-button" (click)="showAddScheduleForm()">
                    <mat-icon>add</mat-icon>
                    Añadir programación
                  </button>
                </div>
              </div>
            </mat-tab>
          </mat-tab-group>
        </mat-card>
      </div>
    </div>
  </div>
</div>
