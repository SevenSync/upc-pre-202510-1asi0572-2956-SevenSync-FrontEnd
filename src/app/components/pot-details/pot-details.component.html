<app-toolbar></app-toolbar>

<div class="pot-details-container">
  <div class="header-section">
    <div class="header-left">
      <button mat-icon-button class="back-button" (click)="goBack()">
        <mat-icon class="back-icon">arrow_back</mat-icon>
      </button>
      <h1 class="page-title">{{ potDetails.name }}</h1>
    </div>
    <div class="header-actions">
      <button mat-stroked-button class="edit-button" (click)="editPot()">
        <mat-icon>edit</mat-icon>
        Editar
      </button>
      <button mat-icon-button class="menu-button">
        <mat-icon>more_vert</mat-icon>
      </button>
    </div>
  </div>

  <div class="content-wrapper">
    <div class="main-layout">
      <!-- Columna Izquierda -->
      <div class="left-column">
        <mat-card class="pot-info-card">
          <div class="pot-image-container">
            <img [src]="potDetails.image" [alt]="potDetails.name" class="pot-image" />
          </div>

          <div class="pot-basic-info">
            <h2 class="pot-name">{{ potDetails.name }}</h2>
            <p class="pot-type">{{ potDetails.plantType }}</p>
            <p class="pot-description">{{ potDetails.description }}</p>
          </div>

          <div class="care-info">

            <div class="care-item">
              <mat-icon class="care-icon">wb_sunny</mat-icon>
              <div class="care-details">
                <span class="care-label">Exposición al sol:</span>
                <span class="care-value">{{ potDetails.sunExposure }}</span>
              </div>
            </div>

            <div class="care-item">
              <mat-icon class="care-icon">water_drop</mat-icon>
              <div class="care-details">
                <span class="care-label">Humedad óptima:</span>
                <span class="care-value">{{ potDetails.optimalHumidity }}</span>
              </div>
            </div>
          </div>
        </mat-card>

        <mat-card class="battery-card">
          <h3 class="battery-title">Estado de la batería</h3>
          <div class="battery-info">
            <div class="battery-level">
              <span class="battery-label">Nivel de batería</span>
              <span class="battery-percentage">{{ potDetails.batteryLevel }}%</span>
            </div>
            <mat-progress-bar
              mode="determinate"
              [value]="potDetails.batteryLevel"
              class="battery-bar"
              [style.--progress-color]="getBatteryColor()">
            </mat-progress-bar>
            <p class="battery-status">Batería en buen estado</p>
          </div>
        </mat-card>
      </div>

      <!-- Columna Derecha -->
      <div class="right-column">
        <!-- Métricas -->
        <div class="metrics-grid">
          <mat-card *ngFor="let metric of metrics" class="metric-card">
            <div class="metric-header">
              <mat-icon class="metric-icon">{{ metric.icon }}</mat-icon>
              <span class="metric-name">{{ metric.name }}</span>
            </div>
            <div class="metric-value">
              <span class="value">{{ metric.value }}</span>
              <span class="unit">{{ metric.unit }}</span>
            </div>
            <mat-progress-bar
              mode="determinate"
              [value]="metric.percentage"
              class="metric-bar"
              [style.--progress-color]="getMetricColor(metric)">
            </mat-progress-bar>
            <p class="metric-optimal">{{ metric.optimal }}</p>
          </mat-card>
        </div>

        <!-- Control de Riego -->
        <mat-card class="watering-control">
          <div class="watering-header">
            <h3 class="watering-title">Control De Riego</h3>
            <p class="watering-status">El nivel de humedad del suelo es adecuado</p>
          </div>
          <button mat-raised-button class="water-button" (click)="waterPlant()">
            <mat-icon>water_drop</mat-icon>
            Regar ahora
          </button>
        </mat-card>

        <!-- Tabs -->
        <mat-card class="tabs-card">
          <mat-tab-group
            class="details-tabs"
            (selectedTabChange)="onTabChange($event.index)"
            [selectedIndex]="selectedTabIndex"
            animationDuration="200ms">

            <mat-tab label="Gráfico">
              <div class="chart-content">
                <div class="chart-header">
                  <div>
                    <h3>{{ hasChartData ? 'Historial de Sensores' : 'Gráfico de Métricas' }}</h3>
                    <p *ngIf="hasChartData" class="chart-subtitle">Monitoreo de las condiciones de tu planta</p>
                  </div>
                  <mat-form-field appearance="outline" class="period-selector">
                    <mat-select [value]="selectedPeriod" (selectionChange)="onPeriodChange($event.value)">
                      <mat-option value="day">Día</mat-option>
                      <mat-option value="week">Semana</mat-option>
                      <mat-option value="month">Mes</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <!-- Gráfico con datos -->
                <div *ngIf="hasChartData" class="chart-container">
                  <div class="chart-with-data"
                       (mousemove)="onChartMouseMove($event)"
                       (mouseleave)="onChartMouseLeave()">
                    <svg class="chart-svg" viewBox="0 0 800 400" preserveAspectRatio="xMidYMid meet">
                      <!-- Cuadrícula -->
                      <defs>
                        <pattern id="grid" width="66.67" height="80" patternUnits="userSpaceOnUse">
                          <path d="M 66.67 0 L 0 0 0 80" fill="none" stroke="#e8e8e8" stroke-width="1"/>
                        </pattern>
                      </defs>
                      <rect width="100%" height="100%" fill="url(#grid)" />

                      <!-- Ejes -->
                      <g class="axes">
                        <!-- Eje Y -->
                        <g class="y-axis">
                          <text x="30" y="60" class="axis-label">80</text>
                          <text x="30" y="140" class="axis-label">60</text>
                          <text x="30" y="220" class="axis-label">40</text>
                          <text x="30" y="300" class="axis-label">20</text>
                          <text x="30" y="380" class="axis-label">0</text>
                        </g>
                        <!-- Eje X -->
                        <g class="x-axis">
                          <text x="60" y="395" class="axis-label">01:00</text>
                          <text x="125" y="395" class="axis-label">03:00</text>
                          <text x="190" y="395" class="axis-label">05:00</text>
                          <text x="255" y="395" class="axis-label">07:00</text>
                          <text x="320" y="395" class="axis-label">09:00</text>
                          <text x="385" y="395" class="axis-label">11:00</text>
                          <text x="450" y="395" class="axis-label">13:00</text>
                          <text x="515" y="395" class="axis-label">15:00</text>
                          <text x="580" y="395" class="axis-label">17:00</text>
                          <text x="645" y="395" class="axis-label">19:00</text>
                          <text x="710" y="395" class="axis-label">21:00</text>
                          <text x="740" y="395" class="axis-label">23:00</text>
                        </g>
                      </g>

                      <!-- Líneas de datos -->
                      <g class="data-lines">
                        <!-- Humedad -->
                        <polyline
                          [attr.points]="getChartPoints('humidity')"
                          fill="none"
                          stroke="#2196F3"
                          stroke-width="2"
                          class="data-line humidity-line"/>

                        <!-- Luz -->
                        <polyline
                          [attr.points]="getChartPoints('light')"
                          fill="none"
                          stroke="#FF9800"
                          stroke-width="2"
                          class="data-line light-line"/>

                        <!-- Temperatura -->
                        <polyline
                          [attr.points]="getChartPoints('temperature')"
                          fill="none"
                          stroke="#F44336"
                          stroke-width="2"
                          class="data-line temperature-line"/>

                        <!-- Acidez -->
                        <polyline
                          [attr.points]="getChartPoints('acidity')"
                          fill="none"
                          stroke="#4CAF50"
                          stroke-width="2"
                          class="data-line acidity-line"/>

                        <!-- Salinidad -->
                        <polyline
                          [attr.points]="getChartPoints('salinity')"
                          fill="none"
                          stroke="#009688"
                          stroke-width="2"
                          class="data-line salinity-line"/>
                      </g>

                      <!-- Puntos de datos -->
                      <g class="data-points">
                        <ng-container *ngFor="let point of chartData; let i = index">
                          <circle
                            [attr.cx]="60 + (i * 680) / (chartData.length - 1)"
                            [attr.cy]="340 - (point.humidity / 80) * 280"
                            r="3"
                            fill="#2196F3"
                            class="data-point humidity-point"/>
                          <circle
                            [attr.cx]="60 + (i * 680) / (chartData.length - 1)"
                            [attr.cy]="340 - (point.light / 80) * 280"
                            r="3"
                            fill="#FF9800"
                            class="data-point light-point"/>
                          <circle
                            [attr.cx]="60 + (i * 680) / (chartData.length - 1)"
                            [attr.cy]="340 - (point.temperature / 80) * 280"
                            r="3"
                            fill="#F44336"
                            class="data-point temperature-point"/>
                          <circle
                            [attr.cx]="60 + (i * 680) / (chartData.length - 1)"
                            [attr.cy]="340 - ((point.acidity * 10) / 80) * 280"
                            r="3"
                            fill="#4CAF50"
                            class="data-point acidity-point"/>
                          <circle
                            [attr.cx]="60 + (i * 680) / (chartData.length - 1)"
                            [attr.cy]="340 - ((point.salinity * 20) / 80) * 280"
                            r="3"
                            fill="#009688"
                            class="data-point salinity-point"/>
                        </ng-container>
                      </g>
                    </svg>

                    <!-- Tooltip -->
                    <div *ngIf="tooltipData.visible"
                         class="chart-tooltip"
                         [style.left.px]="tooltipData.x"
                         [style.top.px]="tooltipData.y">
                      <div class="tooltip-time">{{ tooltipData.time }}</div>
                      <div class="tooltip-item">
                        <span class="tooltip-label">Humedad:</span>
                        <span class="tooltip-value">{{ tooltipData.humidity }}</span>
                      </div>
                      <div class="tooltip-item">
                        <span class="tooltip-label">Luz:</span>
                        <span class="tooltip-value">{{ tooltipData.light }}</span>
                      </div>
                      <div class="tooltip-item">
                        <span class="tooltip-label">Temperatura:</span>
                        <span class="tooltip-value">{{ tooltipData.temperature }}</span>
                      </div>
                      <div class="tooltip-item">
                        <span class="tooltip-label">Acidez:</span>
                        <span class="tooltip-value">{{ tooltipData.acidity }}</span>
                      </div>
                      <div class="tooltip-item">
                        <span class="tooltip-label">Salinidad:</span>
                        <span class="tooltip-value">{{ tooltipData.salinity }}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Leyenda del gráfico -->
                  <div class="chart-legend">
                    <div class="legend-item">
                      <div class="legend-color humidity"></div>
                      <span class="legend-label">Humedad (vol%)</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color light"></div>
                      <span class="legend-label">Luz (lux)</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color temperature"></div>
                      <span class="legend-label">Temperatura (°C)</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color acidity"></div>
                      <span class="legend-label">Acidez (pH)</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color salinity"></div>
                      <span class="legend-label">Salinidad (mS/cm)</span>
                    </div>
                  </div>
                </div>

                <!-- Estado vacío del gráfico -->
                <div *ngIf="!hasChartData" class="chart-container">
                  <div class="chart-empty-state">
                    <div class="chart-placeholder">
                      <div class="chart-grid">
                        <!-- Líneas verticales de la cuadrícula -->
                        <div class="grid-lines vertical">
                          <div class="grid-line" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10,11,12]"></div>
                        </div>
                        <!-- Líneas horizontales de la cuadrícula -->
                        <div class="grid-lines horizontal">
                          <div class="grid-line" *ngFor="let i of [1,2,3,4]"></div>
                        </div>
                      </div>

                      <!-- Ejes del gráfico -->
                      <div class="chart-axes">
                        <!-- Eje Y -->
                        <div class="y-axis">
                          <span class="axis-label" *ngFor="let value of ['80', '60', '40', '20', '0']">{{ value }}</span>
                        </div>
                        <!-- Eje X -->
                        <div class="x-axis">
                          <span class="axis-label" *ngFor="let time of ['01:00', '03:00', '05:00', '07:00', '09:00', '11:00', '13:00', '15:00', '17:00', '19:00', '21:00', '23:00']">{{ time }}</span>
                        </div>
                      </div>

                      <!-- Mensaje de estado vacío -->
                      <div class="empty-chart-message">
                        <div class="empty-icon">
                          <mat-icon>timeline</mat-icon>
                        </div>
                        <h4 class="empty-title">Los sensores de tu planta aún no han recolectado datos.</h4>
                        <p class="empty-description">
                          Dales un momento para adaptarse y comenzar a brindarte la información que necesitas; no tomará más de un minuto.
                        </p>
                      </div>
                    </div>

                    <!-- Leyenda del gráfico -->
                    <div class="chart-legend">
                      <div class="legend-item">
                        <div class="legend-color humidity"></div>
                        <span class="legend-label">Humedad (vol%)</span>
                      </div>
                      <div class="legend-item">
                        <div class="legend-color light"></div>
                        <span class="legend-label">Luz (lux)</span>
                      </div>
                      <div class="legend-item">
                        <div class="legend-color temperature"></div>
                        <span class="legend-label">Temperatura (°C)</span>
                      </div>
                      <div class="legend-item">
                        <div class="legend-color acidity"></div>
                        <span class="legend-label">Acidez (pH)</span>
                      </div>
                      <div class="legend-item">
                        <div class="legend-color salinity"></div>
                        <span class="legend-label">Salinidad (mS/cm)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </mat-tab>

            <mat-tab label="Historial">
              <div class="history-content">
                <div class="history-header">
                  <h3>Historial de Riego</h3>
                  <p>Registro de los últimos riegos de tu planta</p>
                </div>

                <!-- Lista de Historial con datos -->
                <div *ngIf="hasWateringHistory" class="history-list">
                  <div *ngFor="let record of wateringHistory" class="history-item">
                    <div class="history-icon">
                      <mat-icon>water_drop</mat-icon>
                    </div>
                    <div class="history-info">
                      <h4 class="history-type">{{ getWateringTypeLabel(record.type) }}</h4>
                      <p class="history-amount">Cantidad: {{ record.amount }}ml</p>
                    </div>
                    <div class="history-datetime">
                      <span class="history-date">{{ record.date }}, {{ record.time }}</span>
                    </div>
                  </div>
                </div>

                <!-- Estado vacío -->
                <div *ngIf="!hasWateringHistory" class="history-empty-state">
                  <div class="empty-water-icon">
                    <mat-icon>water_drop</mat-icon>
                  </div>
                  <h4 class="empty-history-title">Tu planta aún no ha sido regada desde que la colocaste en esta maceta</h4>
                  <p class="empty-history-description">
                    Podría ser un buen momento para revisar su nivel de humedad: una planta bien hidratada es una planta feliz.
                  </p>
                </div>
              </div>
            </mat-tab>
            <mat-tab label="Recomendaciones">
              <div class="recommendations-content">
                <div class="recommendations-header">
                  <h3>Recomendaciones</h3>
                  <p>Consejos personalizados para el cuidado óptimo de tu planta</p>
                </div>

                <!-- Lista de Recomendaciones con datos -->
                <div *ngIf="hasRecommendations" class="recommendations-list">
                  <div *ngFor="let recommendation of recommendations"
                       class="recommendation-item"
                       [style.background-color]="recommendation.backgroundColor"
                       [style.border-color]="recommendation.borderColor">
                    <div class="recommendation-icon">
                      <mat-icon [style.color]="recommendation.iconColor">{{ recommendation.icon }}</mat-icon>
                    </div>
                    <div class="recommendation-content">
                      <h4 class="recommendation-title">{{ recommendation.title }}</h4>
                      <p class="recommendation-description">{{ recommendation.description }}</p>
                    </div>
                  </div>
                </div>

                <!-- Estado vacío -->
                <div *ngIf="!hasRecommendations" class="recommendations-empty-state">
                  <div class="empty-search-icon">
                    <mat-icon>search</mat-icon>
                  </div>
                  <h4 class="empty-recommendations-title">No tenemos recomendaciones para ti en este momento.</h4>
                  <p class="empty-recommendations-description">
                    Tu planta está en excelente estado. Aun así, siempre es buena idea buscar oportunidades de mejora. ¡Tu planta te lo agradecerá!
                  </p>
                </div>
              </div>
            </mat-tab>
            <mat-tab label="Alertas">
              <div class="alerts-content">
                <div class="alerts-header">
                  <h3>Alertas</h3>
                  <p>Notificaciones importantes sobre el estado de tu planta</p>
                </div>

                <!-- Lista de Alertas con datos -->
                <div *ngIf="hasAlerts" class="alerts-list">
                  <div *ngFor="let alert of alerts"
                       class="alert-item"
                       [style.background-color]="getAlertBackgroundColor(alert.type)"
                       [style.border-color]="getAlertBorderColor(alert.type)">
                    <div class="alert-icon">
                      <mat-icon [style.color]="getAlertIconColor(alert.type)">{{ alert.icon }}</mat-icon>
                    </div>
                    <div class="alert-content">
                      <div class="alert-header">
                        <h4 class="alert-title">{{ alert.title }}</h4>
                        <span class="alert-timestamp">{{ alert.timestamp }}</span>
                      </div>
                      <p class="alert-description">{{ alert.description }}</p>
                    </div>
                  </div>
                </div>

                <!-- Estado vacío -->
                <div *ngIf="!hasAlerts" class="alerts-empty-state">
                  <div class="empty-search-icon">
                    <mat-icon>search</mat-icon>
                  </div>
                  <h4 class="empty-alerts-title">No se han registrado alertas.</h4>
                  <p class="empty-alerts-description">
                    Tu planta está en excelente estado y no necesita cuidados adicionales por ahora. Cuando haya algo que atender, te avisaremos de inmediato
                  </p>
                </div>
              </div>
            </mat-tab>
            <mat-tab label="Reportes">
              <div class="reports-content">
                <div class="reports-header">
                  <h3>Reporte semanal</h3>
                  <p>Resumen del rendimiento de tu planta a lo largo de toda una semana</p>
                </div>

                <!-- Navegador de período -->
                <div class="period-navigator">
                  <button mat-icon-button class="nav-button" (click)="navigateReportPeriod('prev')">
                    <mat-icon>chevron_left</mat-icon>
                  </button>
                  <span class="period-text">{{ getReportPeriodText() }}</span>
                  <button mat-icon-button class="nav-button" (click)="navigateReportPeriod('next')">
                    <mat-icon>chevron_right</mat-icon>
                  </button>
                </div>

                <!-- Estado vacío -->
                <div *ngIf="!hasReportsData" class="reports-empty-state">
                  <div class="empty-reports-icon">
                    <mat-icon>search</mat-icon>
                  </div>
                  <h4 class="empty-reports-title">Aún no tenemos reportes disponibles.</h4>
                  <p class="empty-reports-description">
                    Los datos recolectados por los sensores de tu Monstera Deliciosa todavía no son suficientes para generar un informe semanal. Necesitamos al menos información de los 7 días de la semana para hacerlo.
                  </p>
                </div>

                <!-- Contenido de reportes (cuando hay datos) -->
                <div *ngIf="hasReportsData" class="reports-data">
                  <!-- Aquí irá el contenido del reporte cuando esté disponible -->
                  <div class="report-sections">
                    <mat-card class="report-card">
                      <h4>Resumen de la semana</h4>
                      <p>Contenido del reporte semanal...</p>
                    </mat-card>
                  </div>
                </div>
              </div>
            </mat-tab>
          </mat-tab-group>
        </mat-card>
      </div>
    </div>
  </div>
</div>
